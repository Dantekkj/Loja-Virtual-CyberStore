<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto - CyberStore</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-indigo-900 min-h-screen text-gray-100">

    <!-- Cabe√ßalho -->
    <header class="bg-gradient-to-r from-gray-800/80 to-gray-900/80 backdrop-blur-sm fixed w-full z-50 shadow-md">
        <div class="container mx-auto flex justify-between items-center p-4">
            <h1 class="text-2xl font-bold text-purple-500 animate-pulse"><a href="index.html">Cyber Store</a></h1>
            <nav>
                <ul class="flex space-x-6 items-center">
                    <li><a href="index.html" class="hover:text-purple-500 transition duration-300">In√≠cio</a></li>
                    <li><a href="Produtos.html" class="hover:text-purple-500 transition duration-300">Produtos</a></li>
                    <li><a href="Carrinho.html" class="hover:text-purple-500 transition duration-300">Carrinho</a></li>
                    <!-- Bot√£o de Login (quando n√£o logado) -->
                    <li id="loginButton" class="hidden">
                        <a href="Login.html" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition duration-300 ease-in-out">
                            Login
                        </a>
                    </li>
                    <!-- Menu do Usu√°rio (quando logado) -->
                    <li id="userMenu" class="hidden relative group">
                        <div class="flex items-center space-x-2 cursor-pointer">
                            <img id="userAvatar" src="" alt="Usu√°rio" class="w-10 h-10 rounded-full border-2 border-purple-500">
                            <span id="userName" class="text-gray-100"></span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl border border-purple-500/20 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300">
                            <a href="#" id="logoutButton" class="block px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-purple-400 rounded-lg transition">
                                Sair
                            </a>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="h-20"></div>

    <!-- Loading State -->
    <div id="loading" class="container mx-auto px-4 py-20 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
        <p class="mt-4 text-gray-400">Carregando produto...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden container mx-auto px-4 py-20 text-center">
        <p class="text-red-400 text-lg mb-4">Produto n√£o encontrado.</p>
        <a href="Produtos.html" class="inline-block bg-purple-500 hover:bg-purple-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-300">
            Voltar para Produtos
        </a>
    </div>

    <!-- Conte√∫do do Produto -->
    <div id="produtoContainer" class="hidden container mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm text-gray-400">
            <a href="index.html" class="hover:text-purple-500 transition">In√≠cio</a>
            <span class="mx-2">/</span>
            <a href="Produtos.html" class="hover:text-purple-500 transition">Produtos</a>
            <span class="mx-2">/</span>
            <span id="breadcrumbNome" class="text-gray-300"></span>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Galeria de Imagens -->
            <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700">
                <div class="relative">
                    <img id="imagemPrincipal" src="" alt="" class="w-full h-96 object-contain rounded-lg mb-4">
                    <div id="badgeProduto" class="absolute top-4 right-4"></div>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <img id="thumb1" src="" alt="" class="w-full h-20 object-contain bg-gray-900 rounded cursor-pointer hover:border-2 hover:border-purple-500 border-2 border-purple-500 transition">
                </div>
            </div>

            <!-- Informa√ß√µes do Produto -->
            <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700">
                <h1 id="nomeProduto" class="text-3xl font-bold text-gray-100 mb-4"></h1>
                <div class="flex items-center gap-4 mb-6">
                    <div class="flex items-center">
                        <span id="avaliacao" class="text-yellow-400 text-xl">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                        <span class="ml-2 text-gray-400 text-sm">(4.8)</span>
                    </div>
                    <span class="text-gray-500">|</span>
                    <span id="estoqueInfo" class="text-green-400 font-semibold"></span>
                </div>

                <div class="mb-6">
                    <p class="text-4xl font-bold text-purple-400 mb-2">
                        <span id="precoProduto"></span>
                    </p>
                    <p class="text-gray-400 text-sm">ou 12x de <span id="precoParcela"></span> sem juros</p>
                </div>

                <div class="mb-6 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                    <p class="text-green-400 font-semibold mb-1">‚úì Frete Gr√°tis</p>
                    <p class="text-gray-400 text-sm">Para compras acima de R$ 199,00</p>
                </div>

                <div id="descricaoCurta" class="mb-6 text-gray-300"></div>

                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Quantidade:</label>
                    <div class="flex items-center gap-4">
                        <button id="btnDiminuir" class="bg-gray-700 hover:bg-gray-600 text-white w-10 h-10 rounded-lg transition">-</button>
                        <input type="number" id="quantidade" value="1" min="1" max="10" class="w-20 text-center bg-gray-900 border border-gray-700 rounded-lg text-gray-100 py-2">
                        <button id="btnAumentar" class="bg-gray-700 hover:bg-gray-600 text-white w-10 h-10 rounded-lg transition">+</button>
                    </div>
                </div>

                <div class="flex gap-4 mb-4">
                    <button id="btnComprar" class="flex-1 bg-purple-500 hover:bg-purple-600 text-gray-900 font-bold py-4 rounded-lg transition duration-300 text-lg">
                        Comprar Agora
                    </button>
                    <button id="btnCarrinho" class="bg-gray-700 hover:bg-gray-600 text-gray-100 px-6 py-4 rounded-lg transition duration-300 text-lg">
                        üõí Adicionar ao Carrinho
                    </button>
                </div>

                <div class="pt-6 border-t border-gray-700">
                    <div class="flex items-center gap-2 text-gray-400 mb-2">
                        <span>üîí</span>
                        <span class="text-sm">Compra 100% segura</span>
                    </div>
                    <div class="flex items-center gap-2 text-gray-400 mb-2">
                        <span>‚Ü©Ô∏è</span>
                        <span class="text-sm">Troca e devolu√ß√£o em at√© 7 dias</span>
                    </div>
                    <div class="flex items-center gap-2 text-gray-400">
                        <span>üöö</span>
                        <span class="text-sm">Entrega em todo o Brasil</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Descri√ß√£o Detalhada -->
        <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 mb-8">
            <h2 class="text-2xl font-bold text-gray-100 mb-6">Descri√ß√£o do Produto</h2>
            <div id="descricaoDetalhada" class="text-gray-300 leading-relaxed"></div>
        </div>

        <!-- Especifica√ß√µes -->
        <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 mb-8">
            <h2 class="text-2xl font-bold text-gray-100 mb-6">Especifica√ß√µes T√©cnicas</h2>
            <div id="especificacoes" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
        </div>

        <!-- Produtos Relacionados -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-100 mb-6">Produtos Relacionados</h2>
            <div id="produtosRelacionados" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Rodap√© -->
    <footer class="bg-gray-800 text-gray-400 py-8 mt-10">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 px-4">
            <div>
                <h4 class="font-bold text-gray-100 mb-2">Cyber Store</h4>
                <p>Todos os direitos reservados ¬© 2025</p>
            </div>
            <div>
                <h4 class="font-bold text-gray-100 mb-2">Links</h4>
                <ul>
                    <li><a href="index.html" class="hover:text-purple-500 transition duration-300">In√≠cio</a></li>
                    <li><a href="Produtos.html" class="hover:text-purple-500 transition duration-300">Produtos</a></li>
                    <li><a href="#" class="hover:text-purple-500 transition duration-300">Promo√ß√µes</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-bold text-gray-100 mb-2">Contato</h4>
                <p>Email: SuporteCyber@gmail.com</p>
                <p>Telefone: (14) 99999-9999</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = window.location.origin + '/api/produto';
        const API_CARRINHO = window.location.origin + '/api/carrinho';
        
        // Obter ID do produto da URL
        const urlParams = new URLSearchParams(window.location.search);
        const produtoId = urlParams.get('id');

        let produto = null;
        let quantidade = 1;

        // Fun√ß√£o auxiliar para obter propriedade (case-insensitive)
        function getProp(obj, prop) {
            if (!obj || !prop) return undefined;
            // Tenta primeiro com a propriedade exata
            if (obj[prop] !== undefined) return obj[prop];
            // Tenta com primeira letra mai√∫scula
            const propCapitalized = prop.charAt(0).toUpperCase() + prop.slice(1);
            if (obj[propCapitalized] !== undefined) return obj[propCapitalized];
            // Tenta com tudo min√∫sculo
            if (obj[prop.toLowerCase()] !== undefined) return obj[prop.toLowerCase()];
            // Tenta com tudo mai√∫sculo
            if (obj[prop.toUpperCase()] !== undefined) return obj[prop.toUpperCase()];
            return undefined;
        }

        // Fun√ß√£o para formatar pre√ßo
        function formatarPreco(preco) {
            if (preco === null || preco === undefined || isNaN(preco)) {
                return 'R$ 0,00';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(Number(preco));
        }

        // Fun√ß√£o para calcular parcela
        function calcularParcela(preco, parcelas = 12) {
            const precoNum = Number(preco) || 0;
            return formatarPreco(precoNum / parcelas);
        }

        // Carregar produto
        async function carregarProduto() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const container = document.getElementById('produtoContainer');

            if (!produtoId) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                return;
            }

            try {
                // Tentar m√∫ltiplas URLs poss√≠veis
                const urls = [
                    `${API_URL}/${produtoId}`,
                    `${window.location.origin}/api/produto/${produtoId}`,
                    `http://localhost:5038/api/produto/${produtoId}`,
                    `http://localhost:7233/api/produto/${produtoId}`,
                    `http://localhost:8081/api/produto/${produtoId}`
                ];

                let response = null;
                for (const url of urls) {
                    try {
                        response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) break;
                    } catch (err) {
                        continue;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error('Produto n√£o encontrado');
                }

                produto = await response.json();
                exibirProduto(produto);
                carregarProdutosRelacionados(produtoId);
            } catch (err) {
                console.error('Erro ao carregar produto:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
            }
        }

        // Exibir produto
        function exibirProduto(produto) {
            const loading = document.getElementById('loading');
            const container = document.getElementById('produtoContainer');

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            // Obter propriedades do produto (case-insensitive)
            const id = getProp(produto, 'id') || getProp(produto, 'Id') || 0;
            const nome = getProp(produto, 'nome') || getProp(produto, 'Nome') || '';
            const descricao = getProp(produto, 'descricao') || getProp(produto, 'Descricao') || '';
            const preco = Number(getProp(produto, 'preco') || getProp(produto, 'Preco') || 0);
            const estoque = Number(getProp(produto, 'estoque') || getProp(produto, 'Estoque') || 0);
            const urlImagem = getProp(produto, 'imagemUrl') || getProp(produto, 'ImagemUrl') || '/img/placeholder.png';

            // Imagem
            document.getElementById('imagemPrincipal').src = urlImagem;
            document.getElementById('imagemPrincipal').alt = nome;
            document.getElementById('thumb1').src = urlImagem;

            // Badge
            const badgeContainer = document.getElementById('badgeProduto');
            if (estoque === 0) {
                badgeContainer.innerHTML = '<span class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">ESGOTADO</span>';
            } else if (preco > 3000) {
                badgeContainer.innerHTML = '<span class="bg-purple-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">DESTAQUE</span>';
            } else if (preco < 200) {
                badgeContainer.innerHTML = '<span class="bg-green-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">FRETE GR√ÅTIS</span>';
            }

            // Informa√ß√µes
            document.getElementById('nomeProduto').textContent = nome;
            document.getElementById('breadcrumbNome').textContent = nome;
            document.getElementById('precoProduto').textContent = formatarPreco(preco);
            document.getElementById('precoParcela').textContent = calcularParcela(preco);
            
            // Estoque
            const estoqueInfo = document.getElementById('estoqueInfo');
            if (estoque > 0) {
                estoqueInfo.textContent = `${estoque} unidades em estoque`;
                estoqueInfo.className = 'text-green-400 font-semibold';
            } else {
                estoqueInfo.textContent = 'Fora de estoque';
                estoqueInfo.className = 'text-red-400 font-semibold';
            }

            // Descri√ß√£o
            document.getElementById('descricaoCurta').textContent = descricao || 'Produto de alta qualidade para gamers.';
            document.getElementById('descricaoDetalhada').innerHTML = `
                <p class="mb-4">${descricao || 'Este produto oferece qualidade superior e performance excepcional para sua experi√™ncia de jogo.'}</p>
                <p class="mb-4">Garantia de qualidade e suporte t√©cnico especializado. Produto novo, lacrado e com nota fiscal.</p>
                <ul class="list-disc list-inside space-y-2">
                    <li>Produto original e com garantia do fabricante</li>
                    <li>Entrega r√°pida e segura</li>
                    <li>Suporte t√©cnico especializado</li>
                    <li>Pol√≠tica de troca e devolu√ß√£o</li>
                </ul>
            `;

            // Especifica√ß√µes
            const especificacoes = document.getElementById('especificacoes');
            especificacoes.innerHTML = `
                <div><span class="font-semibold">Nome:</span> ${nome}</div>
                <div><span class="font-semibold">Pre√ßo:</span> ${formatarPreco(preco)}</div>
                <div><span class="font-semibold">Estoque:</span> ${estoque} unidades</div>
                <div><span class="font-semibold">Categoria:</span> Gamer</div>
            `;

            // Bot√µes
            const btnComprar = document.getElementById('btnComprar');
            const btnCarrinho = document.getElementById('btnCarrinho');
            
            if (estoque === 0) {
                btnComprar.disabled = true;
                btnComprar.className = 'flex-1 bg-gray-700 text-gray-500 font-bold py-4 rounded-lg cursor-not-allowed text-lg';
                btnComprar.textContent = 'Indispon√≠vel';
                btnCarrinho.disabled = true;
                btnCarrinho.className = 'bg-gray-700 text-gray-500 px-6 py-4 rounded-lg cursor-not-allowed text-lg';
            } else {
                btnComprar.onclick = () => comprarProduto();
                btnCarrinho.onclick = () => adicionarCarrinho();
            }
        }

        // Controles de quantidade
        document.getElementById('btnDiminuir').addEventListener('click', () => {
            if (quantidade > 1) {
                quantidade--;
                document.getElementById('quantidade').value = quantidade;
            }
        });

        document.getElementById('btnAumentar').addEventListener('click', () => {
            if (produto) {
                const estoque = Number(getProp(produto, 'estoque') || getProp(produto, 'Estoque') || 10);
                const max = estoque || 10;
                if (quantidade < max) {
                    quantidade++;
                    document.getElementById('quantidade').value = quantidade;
                }
            }
        });

        document.getElementById('quantidade').addEventListener('change', (e) => {
            if (produto) {
                const estoque = Number(getProp(produto, 'estoque') || getProp(produto, 'Estoque') || 10);
                quantidade = Math.max(1, Math.min(estoque || 10, parseInt(e.target.value) || 1));
                e.target.value = quantidade;
            }
        });

        // Fun√ß√µes de compra
        async function comprarProduto() {
            await adicionarCarrinho();
            window.location.href = 'Carrinho.html';
        }

        async function adicionarCarrinho() {
            if (!produto) {
                alert('Produto n√£o encontrado!');
                return;
            }

            try {
                const produtoDTO = {
                    Id: getProp(produto, 'id') || getProp(produto, 'Id') || 0,
                    Nome: getProp(produto, 'nome') || getProp(produto, 'Nome') || '',
                    Preco: Number(getProp(produto, 'preco') || getProp(produto, 'Preco') || 0),
                    Descricao: getProp(produto, 'descricao') || getProp(produto, 'Descricao') || '',
                    Estoque: Number(getProp(produto, 'estoque') || getProp(produto, 'Estoque') || 0),
                    ImagemUrl: getProp(produto, 'imagemUrl') || getProp(produto, 'ImagemUrl') || '',
                    Quantidade: quantidade
                };

                const response = await fetch(API_CARRINHO, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(produtoDTO)
                });

                if (response.ok) {
                    const nome = getProp(produto, 'nome') || getProp(produto, 'Nome') || '';
                    const preco = Number(getProp(produto, 'preco') || getProp(produto, 'Preco') || 0);
                    alert(`‚úÖ Produto "${nome}" adicionado ao carrinho!\nQuantidade: ${quantidade}\nTotal: ${formatarPreco(preco * quantidade)}`);
                } else {
                    const error = await response.json();
                    alert(`Erro ao adicionar produto: ${error.mensagem || 'Erro desconhecido'}`);
                }
            } catch (err) {
                console.error('Erro ao adicionar ao carrinho:', err);
                alert('Erro ao adicionar produto ao carrinho. Tente novamente.');
            }
        }

        // Carregar produtos relacionados
        async function carregarProdutosRelacionados(produtoIdAtual) {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) return;

                const produtos = await response.json();
                const relacionados = produtos
                    .filter(p => {
                        const id = getProp(p, 'id') || getProp(p, 'Id') || 0;
                        const estoque = Number(getProp(p, 'estoque') || getProp(p, 'Estoque') || 0);
                        return id !== parseInt(produtoIdAtual) && estoque > 0;
                    })
                    .slice(0, 4);

                const container = document.getElementById('produtosRelacionados');
                if (relacionados.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">Nenhum produto relacionado encontrado.</p>';
                    return;
                }

                container.innerHTML = relacionados.map(p => {
                    const id = getProp(p, 'id') || getProp(p, 'Id') || 0;
                    const nome = getProp(p, 'nome') || getProp(p, 'Nome') || '';
                    const preco = Number(getProp(p, 'preco') || getProp(p, 'Preco') || 0);
                    const urlImagem = getProp(p, 'imagemUrl') || getProp(p, 'ImagemUrl') || '/img/placeholder.png';
                    return `
                        <div class="bg-gray-800 rounded-xl overflow-hidden hover:shadow-2xl hover:shadow-purple-500/30 hover:scale-105 transition-all duration-500 border border-gray-700 hover:border-purple-500/50 group cursor-pointer" onclick="window.location.href='ProdutoDetalhes.html?id=${id}'">
                            <div class="relative overflow-hidden bg-gray-900/50 p-4">
                                <img src="${urlImagem}" alt="${nome}" class="w-full h-48 object-contain group-hover:scale-110 transition duration-500">
                            </div>
                            <div class="p-5">
                                <h3 class="font-bold text-lg text-gray-100 mb-2 line-clamp-2">${nome}</h3>
                                <p class="text-2xl font-bold text-purple-400">${formatarPreco(preco)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Erro ao carregar produtos relacionados:', err);
            }
        }

        // Carregar produto ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', carregarProduto);
    </script>

    <!-- Script de Autentica√ß√£o -->
    <script src="js/auth.js"></script>

</body>
</html>

